<!DOCTYPE html>
<html>
  <head>
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <style>
      #custom-debug {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: #00ff00;
        padding: 15px;
        font-family: monospace;
        font-size: 18px;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 99999;
        border: 2px solid #00ff00;
      }
      #custom-debug .log-entry {
        margin: 5px 0;
        word-wrap: break-word;
      }
      #custom-debug .error {
        color: #ff0000;
      }
      #custom-debug .warn {
        color: #ffff00;
      }
      #custom-debug .info {
        color: #00ffff;
      }
    </style>
  </head>
  <body>
    <cast-media-player></cast-media-player>

    <!-- WÅASNY DEBUG OVERLAY -->
    <div id="custom-debug">
      <strong>ğŸŸ¢ DEBUG MODE AKTYWNY</strong>
      <div id="log-container"></div>
    </div>

    <script>
      // Globalny handler bÅ‚Ä™dÃ³w JavaScript
      window.onerror = function(message, source, lineno, colno, error) {
        const errorDetails = `âš ï¸ ERROR: ${message}\nÅ¹rÃ³dÅ‚o: ${source}\nLinia: ${lineno}:${colno}\nSzczegÃ³Å‚y: ${error ? error.stack || error.message : 'Brak szczegÃ³Å‚Ã³w'}`;
        // Logowanie do konsoli
        console.error(errorDetails);
        
        // Logowanie na ekranie jeÅ›li funkcja logToScreen istnieje
        if (window.logToScreen) {
          window.logToScreen(errorDetails, "error");
        } else {
          // Funkcja logToScreen jeszcze nie zostaÅ‚a zdefiniowana, dodaj bÅ‚Ä…d do kolejki
          if (!window._errorQueue) window._errorQueue = [];
          window._errorQueue.push({ message: errorDetails, type: "error" });
        }
        
        // ZwrÃ³Ä‡ true, aby zapobiec wyÅ›wietlaniu bÅ‚Ä™du w konsoli przeglÄ…darki
        return true;
      };
      
      // Handler dla odrzuconych obietnic (Promise)
      window.addEventListener('unhandledrejection', function(event) {
        const errorDetails = `âŒ NieobsÅ‚uÅ¼one odrzucenie obietnicy: ${event.reason}`;
        console.error(errorDetails, event);
        
        if (window.logToScreen) {
          window.logToScreen(errorDetails, "error");
        } else {
          if (!window._errorQueue) window._errorQueue = [];
          window._errorQueue.push({ message: errorDetails, type: "error" });
        }
      });

      // Inicjalizacja kontekstu
      const context = cast.framework.CastReceiverContext.getInstance();
      const playerManager = context.getPlayerManager();
      const logContainer = document.getElementById("log-container");

      // UtwÃ³rz konfiguracjÄ™ dla kontekstu odtwarzacza
      const castOptions = new cast.framework.CastReceiverOptions();

      // Konfiguracja odtwarzacza
      castOptions.playbackConfig = new cast.framework.PlaybackConfig();

      // Funkcja logowania dostÄ™pna globalnie
      window.logToScreen = function(message, type = "info") {
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;
        const timestamp = new Date().toLocaleTimeString();
        entry.textContent = `[${timestamp}] ${message}`;
        logContainer.appendChild(entry);

        // Autoscroll do najnowszych logÃ³w
        logContainer.scrollTop = logContainer.scrollHeight;

        // Ogranicz do ostatnich 30 wpisÃ³w (zwiÄ™kszyÅ‚em limit dla bÅ‚Ä™dÃ³w)
        if (logContainer.children.length > 30) {
          logContainer.removeChild(logContainer.firstChild);
        }
      };
      
      // SprawdÅº, czy istniejÄ… bÅ‚Ä™dy w kolejce do wyÅ›wietlenia
      if (window._errorQueue && window._errorQueue.length > 0) {
        console.log(`WyÅ›wietlanie ${window._errorQueue.length} bÅ‚Ä™dÃ³w z kolejki`);
        window._errorQueue.forEach(err => {
          window.logToScreen(err.message, err.type);
        });
        window._errorQueue = []; // WyczyÅ›Ä‡ kolejkÄ™
      }

      context.addEventListener(cast.framework.system.EventType.READY, () => {
        logToScreen("ğŸ“¡ Context READY", "info");
      });

      // Interceptor LOAD
      playerManager.setMessageInterceptor(
        cast.framework.messages.MessageType.LOAD,
        (loadRequestData) => {
          logToScreen("ğŸ“¥ LOAD REQUEST otrzymany!", "info");

          // Zapisz customData do zmiennej globalnej
          const customData = loadRequestData.media.customData || {};
          const headers = customData.headers || {};

          // WyÅ›wietl informacje o nagÅ‚Ã³wkach
          if (Object.keys(headers).length > 0) {
            logToScreen(
              `ğŸ”„ Znaleziono niestandardowe nagÅ‚Ã³wki: ${JSON.stringify(
                headers
              )}`,
              "info"
            );

            // Ustaw funkcje obsÅ‚ugi Å¼Ä…daÅ„, ktÃ³re bÄ™dÄ… dodawaÄ‡ niestandardowe nagÅ‚Ã³wki
            castOptions.playbackConfig.licenseRequestHandler = (
              requestInfo
            ) => {
              applyCustomHeaders(requestInfo, headers);
              return requestInfo;
            };

            castOptions.playbackConfig.manifestRequestHandler = (
              requestInfo
            ) => {
              applyCustomHeaders(requestInfo, headers);
              return requestInfo;
            };

            castOptions.playbackConfig.segmentRequestHandler = (
              requestInfo
            ) => {
              applyCustomHeaders(requestInfo, headers);
              return requestInfo;
            };

            // Aktualizuj konfiguracjÄ™ na bieÅ¼Ä…co
            context.updatePlaybackConfig(castOptions.playbackConfig);

            logToScreen(
              "âœ… Zaktualizowano konfiguracjÄ™ odtwarzania z niestandardowymi nagÅ‚Ã³wkami",
              "info"
            );
          } else {
            logToScreen(
              "â„¹ï¸ Brak niestandardowych nagÅ‚Ã³wkÃ³w do zastosowania",
              "info"
            );
          }

          return loadRequestData;
        }
      );

      // Funkcja pomocnicza do stosowania nagÅ‚Ã³wkÃ³w
      function applyCustomHeaders(requestInfo, headers) {
        try {
          Object.entries(headers).forEach(([key, value]) => {
            requestInfo.headers[key] = String(value);
            window.logToScreen(
              `âœ… Dodano nagÅ‚Ã³wek do Å¼Ä…dania: ${key}: ${value}`,
              "info"
            );
          });
        } catch (error) {
          window.logToScreen(`âŒ BÅ‚Ä…d przy ustawianiu nagÅ‚Ã³wkÃ³w: ${error}`, "error");
        }
      }
      
      // Dodaj przycisk do testowania obsÅ‚ugi bÅ‚Ä™dÃ³w
      const debugContainer = document.getElementById("custom-debug");
      const testErrorButton = document.createElement("button");
      testErrorButton.textContent = "ğŸ§ª Testuj obsÅ‚ugÄ™ bÅ‚Ä™dÃ³w";
      testErrorButton.style.background = "#444";
      testErrorButton.style.color = "#fff";
      testErrorButton.style.border = "1px solid #00ff00";
      testErrorButton.style.padding = "5px 10px";
      testErrorButton.style.margin = "10px 0";
      testErrorButton.style.cursor = "pointer";
      testErrorButton.onclick = function() {
        window.logToScreen("ğŸ§ª Testowanie obsÅ‚ugi bÅ‚Ä™dÃ³w...", "info");
        
        // Test 1: BÅ‚Ä…d w synchronicznym kodzie
        setTimeout(() => {
          try {
            const obj = null;
            obj.nonExistingMethod();
          } catch (e) {
            window.logToScreen("âœ… Test 1: ZÅ‚apany bÅ‚Ä…d synchroniczny", "info");
          }
        }, 500);
        
        // Test 2: NiezÅ‚apany bÅ‚Ä…d - powinien byÄ‡ przechwycony przez window.onerror
        setTimeout(() => {
          const a = nonExistingVariable + 1;
        }, 1000);
        
        // Test 3: NieobsÅ‚uÅ¼ona obietnica - powinna byÄ‡ przechwycona przez unhandledrejection
        setTimeout(() => {
          new Promise((resolve, reject) => {
            reject(new Error("Testowy bÅ‚Ä…d obietnicy"));
          });
        }, 1500);
      };
      
      debugContainer.insertBefore(testErrorButton, logContainer);

      // Konfiguracja handlerÃ³w Å¼Ä…daÅ„
      castOptions.playbackConfig.licenseRequestHandler = (requestInfo) => {
        // Te nagÅ‚Ã³wki bÄ™dÄ… aktualizowane po otrzymaniu LOAD MESSAGE
        return requestInfo;
      };

      castOptions.playbackConfig.manifestRequestHandler = (requestInfo) => {
        // Te nagÅ‚Ã³wki bÄ™dÄ… aktualizowane po otrzymaniu LOAD MESSAGE
        return requestInfo;
      };

      castOptions.playbackConfig.segmentRequestHandler = (requestInfo) => {
        // Te nagÅ‚Ã³wki bÄ™dÄ… aktualizowane po otrzymaniu LOAD MESSAGE
        return requestInfo;
      };

      // NasÅ‚uchuj na bÅ‚Ä™dy odtwarzacza
      playerManager.addEventListener(cast.framework.events.EventType.ERROR, (event) => {
        const errorCode = event.detailedErrorCode || event.errorCode || 'UNKNOWN_ERROR';
        const errorMessage = `ğŸ”´ BÅ‚Ä…d odtwarzacza: ${errorCode} - ${event.error ? event.error.message : 'Brak szczegÃ³Å‚Ã³w'}`;
        window.logToScreen(errorMessage, "error");
        
        // Dodatkowe informacje o bÅ‚Ä™dzie
        if (event.error && event.error.stack) {
          window.logToScreen(`Stack bÅ‚Ä™du: ${event.error.stack}`, "error");
        }
      });
      
      // NasÅ‚uchuj na bÅ‚Ä™dy buforowania
      playerManager.addEventListener(cast.framework.events.EventType.BUFFERING, (event) => {
        if (event.isBuffering) {
          window.logToScreen("â³ Buforowanie rozpoczÄ™te...", "info");
        } else {
          window.logToScreen("â–¶ï¸ Buforowanie zakoÅ„czone", "info");
        }
      });
      
      // NasÅ‚uchuj na bÅ‚Ä™dy sieci
      context.addEventListener(cast.framework.system.EventType.SENDER_DISCONNECTED, (event) => {
        window.logToScreen(`ğŸ“µ Nadawca odÅ‚Ä…czony: ${event.reason || 'Nieznany powÃ³d'}`, "warn");
      });
      
      // Uruchom odbiornik z konfiguracjÄ…
      try {
        context.start(castOptions);
        window.logToScreen(
          "ğŸš€ Context.start() wywoÅ‚any z niestandardowÄ… konfiguracjÄ…",
          "info"
        );
      } catch (error) {
        window.logToScreen(`âŒ BÅ‚Ä…d podczas uruchamiania kontekstu: ${error.message}`, "error");
      }
    </script>
  </body>
</html>
